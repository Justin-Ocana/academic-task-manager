{% extends 'Dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Configuración de Notificaciones - Agenda Virtual Eiwa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile-settings.css' %}">
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1>Configuración de Notificaciones</h1>
        <p>Administra cómo y cuándo recibes notificaciones</p>
    </div>

    <div class="settings-card">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            Preferencias de Notificaciones
        </h2>

        <form method="post" action="{% url 'update_preferences' %}">
            {% csrf_token %}

            <div class="preference-item">
                <div class="preference-info">
                    <h3>Notificaciones Push</h3>
                    <p>Recibe notificaciones en tiempo real en tu navegador</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="push_notifications">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="preference-item">
                <div class="preference-info">
                    <h3>Notificaciones por Email</h3>
                    <p>Recibe resúmenes diarios de actividad por correo</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="email_notifications">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="preference-item">
                <div class="preference-info">
                    <h3>Sonidos de Notificación</h3>
                    <p>Reproduce un sonido cuando llegue una notificación</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="notification_sounds">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 18px; height: 18px;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Guardar Cambios
                </button>
                <a href="{% url 'profile_settings' %}" class="btn-secondary">Volver</a>
            </div>
        </form>
    </div>

    <div class="settings-card">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            Permisos del Navegador
        </h2>

        <div class="preference-item">
            <div class="preference-info">
                <h3>Estado de Permisos</h3>
                <p id="permission-status">Verificando permisos...</p>
            </div>
            <button type="button" class="btn-primary" id="request-permission" style="display: none;">
                Activar Notificaciones
            </button>
        </div>
    </div>
</div>

<script>
    // Verificar estado de permisos de notificaciones
    document.addEventListener('DOMContentLoaded', () => {
        const statusEl = document.getElementById('permission-status');
        const requestBtn = document.getElementById('request-permission');

        if ('Notification' in window) {
            const permission = Notification.permission;

            if (permission === 'granted') {
                statusEl.textContent = '✅ Notificaciones activadas';
                statusEl.style.color = '#28a745';
            } else if (permission === 'denied') {
                statusEl.textContent = '❌ Notificaciones bloqueadas. Debes habilitarlas en la configuración del navegador.';
                statusEl.style.color = '#dc3545';
            } else {
                statusEl.textContent = '⚠️ Notificaciones no activadas';
                statusEl.style.color = '#ffc107';
                requestBtn.style.display = 'inline-flex';
            }
        } else {
            statusEl.textContent = '❌ Tu navegador no soporta notificaciones';
            statusEl.style.color = '#dc3545';
        }

        // Solicitar permisos
        requestBtn?.addEventListener('click', async () => {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showToast('Notificaciones activadas exitosamente', 'success');
                    location.reload();
                } else {
                    showToast('Permisos de notificación denegados', 'error');
                }
            } catch (error) {
                showToast('Error al solicitar permisos', 'error');
            }
        });
    });
</script>
{% endblock %}