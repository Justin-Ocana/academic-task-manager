{% extends 'Dashboard/base_dashboard.html' %}
{% load static %}
{% load avatar_tags %}

{% block title %}{{ group.name }} - Agenda Virtual Eiwa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/groups.css' %}">
{% endblock %}

{% block content %}
<div class="group-header">
    <div class="group-info">
        <h1>{{ group.name }}</h1>
        <p>{{ group.description }}</p>
        <div class="group-meta">
            <span class="meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                {{ members_count }}/{{ group.max_members }} miembros
            </span>
            {% if is_leader %}
            <span class="meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                Líder
            </span>
            {% endif %}
        </div>
    </div>

    <div class="group-actions">
        <a href="{% url 'group_history' group.id %}" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Historial
        </a>
        {% if is_leader %}
        <button class="btn btn-secondary" onclick="showInviteCode()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Código de Invitación
        </button>
        <a href="{% url 'group_settings' group.id %}" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m0 6l4.2 4.2M23 12h-6m-6 0H1m18.2 5.2l-4.2-4.2m0-6l4.2-4.2">
                </path>
            </svg>
            Configuración
        </a>
        <button class="btn btn-danger" onclick="confirmDeleteGroup()" data-single-click>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Eliminar Grupo
        </button>
        {% else %}
        <button class="btn btn-warning" onclick="confirmLeaveGroup()" data-single-click>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Salir del Grupo
        </button>
        {% endif %}
    </div>
</div>

<div class="tabs-wrapper">
    <div class="group-tabs" id="groupTabs">
        <button class="tab-btn active" data-tab="overview">Resumen</button>
        <button class="tab-btn" data-tab="members">Miembros</button>
        {% if is_leader %}
        <button class="tab-btn" data-tab="requests">
            Solicitudes
            {% if pending_requests %}
            <span class="badge-count">{{ pending_requests|length }}</span>
            {% endif %}
        </button>
        <button class="tab-btn" data-tab="activity">Actividad</button>
        {% endif %}
    </div>
    <div class="scroll-indicator" id="scrollIndicator">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </div>
</div>

<div class="tab-content active" id="overview">
    <div class="overview-header">
        <h2>Información del Grupo</h2>
    </div>

    <div class="stats-grid">
        <div class="stat-box stat-members">
            <div class="stat-icon-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ members_count }}/{{ group.max_members }}</h3>
                <p>Miembros Activos</p>
                <span class="stat-detail">{{ available_slots }} espacio(s) disponible(s)</span>
            </div>
        </div>
        <div class="stat-box stat-leaders">
            <div class="stat-icon-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ leaders_count }}</h3>
                <p>Líder(es)</p>
                <span class="stat-detail">{{ co_leaders_count }} co-líder(es)</span>
            </div>
        </div>
        <div class="stat-box stat-settings">
            <div class="stat-icon-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ group.get_entry_type_display }}</h3>
                <p>Tipo de Ingreso</p>
                <span class="stat-detail">{% if group.is_invite_active %}Código activo{% else %}Código inactivo{% endif %}</span>
            </div>
        </div>
        <div class="stat-box stat-created">
            <div class="stat-icon-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ group.created_at|date:"d/m/Y" }}</h3>
                <p>Fecha de Creación</p>
                <span class="stat-detail">Hace {{ group.created_at|timesince }}</span>
            </div>
        </div>
    </div>

    {% if is_leader and pending_requests %}
    <div class="quick-alert">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <div>
            <strong>Tienes {{ pending_requests|length }} solicitud(es) pendiente(s)</strong>
            <p>Revisa la pestaña de Solicitudes para aprobar o rechazar</p>
        </div>
    </div>
    {% endif %}
</div>

<div class="tab-content" id="members">
    <h3 style="margin-bottom: 20px;">Miembros Activos</h3>
    <div class="members-list">
        {% for member in members %}
        <div class="member-card">
            {% render_avatar_inline member.user '48px' %}
            <div class="member-info">
                <h4>{{ member.user.nombre }} {{ member.user.apellido }}</h4>
                <span class="member-role">{{ member.get_role_display }}</span>
            </div>
            {% if is_leader and member.role != 'leader' %}
            <div class="member-actions">
                <div class="dropdown">
                    <button class="btn-icon dropdown-toggle" onclick="toggleDropdown({{ member.id }})" title="Opciones">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="dropdown-{{ member.id }}">
                        {% if member.role == 'member' %}
                        <form method="post" action="{% url 'promote_member' member.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                Promover a Co-líder
                            </button>
                        </form>
                        {% elif member.role == 'co_leader' %}
                        <form method="post" action="{% url 'demote_member' member.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="8.5" cy="7" r="4"></circle>
                                </svg>
                                Degradar a Miembro
                            </button>
                        </form>
                        {% endif %}
                        <form method="post" action="{% url 'remove_member' member.id %}" style="display: inline;"
                            onsubmit="return confirm('¿Estás seguro de expulsar a {{ member.user.nombre }} del grupo?');">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item warning">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                Expulsar del Grupo
                            </button>
                        </form>
                        <form method="post" action="{% url 'ban_member' member.id %}" style="display: inline;"
                            onsubmit="return confirm('¿Estás seguro de BANEAR a {{ member.user.nombre }}? No podrá volver a unirse con el código.');">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item danger">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                </svg>
                                Banear del Grupo
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    {% if is_leader and banned_users %}
    <div class="banned-section">
        <h3>Usuarios Baneados</h3>
        <div class="members-list">
            {% for banned in banned_users %}
            <div class="member-card banned-card">
                <div class="member-avatar banned-avatar">{{ banned.user.nombre.0 }}{{ banned.user.apellido.0 }}</div>
                <div class="member-info">
                    <h4>{{ banned.user.nombre }} {{ banned.user.apellido }}</h4>
                    <span class="member-role banned-label">Baneado</span>
                    <small style="display: block; color: #999; font-size: 0.8rem; margin-top: 3px;">
                        Por {{ banned.banned_by.nombre }} el {{ banned.banned_at|date:"d/m/Y" }}
                    </small>
                </div>
                <div class="member-actions">
                    <form method="post" action="{% url 'unban_user' banned.id %}" style="display: inline;"
                        onsubmit="return confirm('¿Desbanear a {{ banned.user.nombre }}?');">
                        {% csrf_token %}
                        <button type="submit" class="btn-icon" title="Desbanear">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

{% if is_leader %}
<div class="tab-content" id="requests">
    {% if pending_requests %}
    <div class="pending-approvals-list">
        {% for request in pending_requests %}
        <div class="approval-card">
            <div class="approval-info">
                <strong>{{ request.user.nombre }} {{ request.user.apellido }}</strong>
                <span>{{ request.user.email }}</span>
                {% if request.message %}
                <p class="approval-message">{{ request.message }}</p>
                {% endif %}
                <small style="color: #999; font-size: 0.8rem;">Solicitado el {{ request.created_at|date:"d/m/Y H:i"
                    }}</small>
            </div>
            <div class="approval-actions">
                <form method="post" action="{% url 'approve_request' request.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-primary">Aprobar</button>
                </form>
                <form method="post" action="{% url 'reject_request' request.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-secondary">Rechazar</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No hay solicitudes pendientes</p>
    {% endif %}
</div>

<div class="tab-content" id="activity">
    {% if recent_activities %}
    <div class="activity-list">
        {% for activity in recent_activities %}
        <div class="activity-item">
            <div class="activity-icon">
                {% if activity.activity_type == 'member_joined' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                {% elif activity.activity_type == 'member_left' or activity.activity_type == 'member_removed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                {% elif activity.activity_type == 'role_changed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                {% elif activity.activity_type == 'settings_changed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m0 6l4.2 4.2M23 12h-6m-6 0H1m18.2 5.2l-4.2-4.2m0-6l4.2-4.2"></path>
                </svg>
                {% else %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                {% endif %}
            </div>
            <div class="activity-content">
                <p class="activity-description">
                    {% if activity.description %}
                        {{ activity.description }}
                    {% else %}
                        {{ activity.get_activity_type_display }}
                        {% if activity.user %}
                            - {{ activity.user.nombre }} {{ activity.user.apellido }}
                        {% endif %}
                    {% endif %}
                </p>
                <span class="activity-time">{{ activity.created_at|timesince }} atrás</span>
            </div>
        </div>
        {% endfor %}
    </div>
    <a href="{% url 'group_history' group.id %}" class="view-all-link">Ver todo el historial →</a>
    {% else %}
    <p class="empty-state">No hay actividad reciente</p>
    {% endif %}
</div>
{% endif %}

<!-- Modal para código de invitación -->
<div id="inviteModal" class="modal">
    <div class="modal-content">
        <h2>Código de Invitación</h2>
        <div class="invite-code-display">
            <code>{{ group.invite_code }}</code>
            <button class="btn-icon" onclick="copyCode()" title="Copiar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
        </div>
        <p>Comparte este código con las personas que quieras invitar al grupo</p>
        <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showInviteCode() {
        document.getElementById('inviteModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('inviteModal').style.display = 'none';
    }

    function copyCode() {
        const code = '{{ group.invite_code }}';
        navigator.clipboard.writeText(code);
        showToast('Código copiado al portapapeles', 'success');
    }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const tab = this.dataset.tab;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(tab).classList.add('active');
        });
    });

    // Scroll indicator para tabs en móvil
    const groupTabs = document.getElementById('groupTabs');
    const scrollIndicator = document.getElementById('scrollIndicator');

    function checkScroll() {
        if (groupTabs && scrollIndicator) {
            const isScrollable = groupTabs.scrollWidth > groupTabs.clientWidth;
            const isAtEnd = groupTabs.scrollLeft >= (groupTabs.scrollWidth - groupTabs.clientWidth - 10);

            if (isScrollable && !isAtEnd && window.innerWidth <= 768) {
                scrollIndicator.style.display = 'flex';
            } else {
                scrollIndicator.style.display = 'none';
            }
        }
    }

    if (groupTabs) {
        groupTabs.addEventListener('scroll', checkScroll);
        window.addEventListener('resize', checkScroll);
        checkScroll();
    }

    // Dropdown para acciones de miembros
    function toggleDropdown(memberId) {
        const dropdown = document.getElementById('dropdown-' + memberId);
        const allDropdowns = document.querySelectorAll('.dropdown-menu');

        // Cerrar otros dropdowns
        allDropdowns.forEach(d => {
            if (d !== dropdown) {
                d.classList.remove('show');
            }
        });

        // Toggle el dropdown actual
        dropdown.classList.toggle('show');
    }

    // Cerrar dropdown al hacer click fuera
    document.addEventListener('click', function (event) {
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    // Confirmar salir del grupo
    async function confirmLeaveGroup() {
        const confirmed = await showConfirm({
            title: '¿Estás seguro de que quieres salir de este grupo?',
            message: 'Perderás acceso a todas las tareas y contenido del grupo.',
            confirmText: 'Aceptar',
            cancelText: 'Cancelar',
            type: 'danger'
        });
        if (confirmed) {
            leaveGroup();
        }
    }

    async function leaveGroup() {
        try {
            const response = await fetch('{% url "leave_group" group.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                toast.success('Has salido del grupo exitosamente');
                setTimeout(() => {
                    window.location.href = '{% url "group_list" %}';
                }, 1000);
            } else {
                toast.error(data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            toast.error('Error al salir del grupo');
        }
    }

    // Confirmar eliminar grupo
    function confirmDeleteGroup() {
        const groupName = '{{ group.name }}';
        showDeleteGroupModal(groupName);
    }

    function showDeleteGroupModal(groupName) {
        // Crear el modal
        const modal = document.createElement('div');
        modal.className = 'delete-group-modal';
        modal.innerHTML = `
            <div class="delete-modal-overlay"></div>
            <div class="delete-modal-content">
                <div class="delete-modal-header">
                    <div class="delete-icon-danger">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <h2>Eliminar Grupo</h2>
                    <p class="group-name-highlight">"${groupName}"</p>
                </div>
                
                <div class="delete-modal-body">
                    <div class="warning-box">
                        <strong>ADVERTENCIA: Esta acción es permanente e irreversible</strong>
                    </div>
                    
                    <div class="consequences-list">
                        <p class="consequences-title">Al eliminar este grupo se perderá:</p>
                        <ul>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Todas las tareas creadas en el grupo
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Todos los miembros serán removidos
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Todo el historial de actividades
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Todas las configuraciones del grupo
                            </li>
                        </ul>
                    </div>
                    
                    <div class="confirmation-input-section">
                        <label for="confirmGroupName">Para confirmar, escribe el nombre del grupo:</label>
                        <input type="text" id="confirmGroupName" class="confirm-input" placeholder="Escribe: ${groupName}" autocomplete="off">
                        <span class="input-hint">Debe coincidir exactamente</span>
                    </div>
                </div>
                
                <div class="delete-modal-footer">
                    <button class="btn-modal-cancel" onclick="closeDeleteModal()">
                        Cancelar
                    </button>
                    <button class="btn-modal-delete" onclick="validateAndDelete('${groupName}')" disabled>
                        Eliminar Grupo Permanentemente
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Animar entrada
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);

        // Validar input en tiempo real
        const input = document.getElementById('confirmGroupName');
        const deleteBtn = modal.querySelector('.btn-modal-delete');

        input.addEventListener('input', function () {
            if (this.value === groupName) {
                deleteBtn.disabled = false;
                deleteBtn.classList.add('enabled');
            } else {
                deleteBtn.disabled = true;
                deleteBtn.classList.remove('enabled');
            }
        });

        // Focus en el input
        setTimeout(() => input.focus(), 300);
    }

    function closeDeleteModal() {
        const modal = document.querySelector('.delete-group-modal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => modal.remove(), 300);
        }
    }

    function validateAndDelete(groupName) {
        const input = document.getElementById('confirmGroupName');
        if (input.value === groupName) {
            closeDeleteModal();
            deleteGroup();
        } else {
            showToast('El nombre no coincide', 'error');
            input.classList.add('error-shake');
            setTimeout(() => input.classList.remove('error-shake'), 500);
        }
    }

    async function deleteGroup() {
        try {
            const response = await fetch('{% url "delete_group" group.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                toast.success(data.message);
                setTimeout(() => {
                    window.location.href = '{% url "group_list" %}';
                }, 1500);
            } else {
                toast.error(data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            toast.error('Error al eliminar el grupo');
        }
    }
</script>
{% endblock %}